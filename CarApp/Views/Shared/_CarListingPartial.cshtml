@model CarInfoViewModel
@inject IFavouritesService favouriteService
@inject SignInManager<ApplicationUser> SignInManager
@{

    
}
<style>
    .car-listing {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        background-color: #f2f2f2;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
    }

        .car-listing:hover {
            background-color: #f2f2f2;
            box-shadow: 0 0 8px rgb(0, 0, 0);
        }

    .car-image-container {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #000000;
        border-radius: 8px;
        padding: 5px;
        width: 350px;
        height: 200px;
        position: relative;
        overflow: hidden;
    }

    .car-dateposted {
        color: dimgray;
        font-size: 1rem;
        font-weight: 400;
    }

    .car-content {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
    }

    .car-bottom-container {
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }

    .car-image-container:hover {
        background-color: cornflowerblue;
    }


    .car-title:hover {
        color: cornflowerblue;
    }

    .car-title {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: left;
    }

    .car-details span {
        margin-right: 15px;
    }

    .car-details {
        text-align: left;
        padding-left: 20px;
    }

    .car-description {
        text-align: left;
        padding-left: 20px;
        padding-right: 20px;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.5;
        max-height: calc(1.5em * 2);
    }

    .car-region {
        font-weight: bold;
        text-align: left;
        font-size: 1.2rem;
        padding-left: 20px;
    }

    .title {
        display: grid;
        grid-template-columns: 1fr auto auto;
        grid-gap: 20px;
        padding-left: 20px;
    }

    .car-price {
        font-size: 1.8rem;
        font-weight: bold;
        color: green;
    }




    .fav-button {
        visibility: hidden;
    }

    #star {
        font-size: 35px;
        visibility: visible;
        color: cornflowerblue;
    }

    .button-options {
        visibility: hidden;
    }

    .options-dots {
        font-size: 1.5rem;
        visibility: visible;
        color: black;
    }

</style>

<div class="car-listing d-flex">
    <a asp-controller="CarListings" asp-action="Details" asp-route-id="@Model.Id" class="text-reset text-decoration-none">
    <div class="car-image-container">
            <img src="~/images/@Model.ImageUrl" alt="Car Image" class="car-image"
                 style="width: 100%;height: 100%;object-fit:cover; object-position: center; border-radius:inherit;">
    </div>
</a>
    <div class="ms-2 flex-grow-1 car-content">
        <div class="title">
            <div>
                <a asp-controller="CarListings" asp-action="Details" asp-route-id="@Model.Id" class="text-reset text-decoration-none">
                <div class="car-title">@Model.Brand @Model.Model @Model.Trim </div>
                </a>
            </div>
            <div class="title-price">
                <div class="car-price">@Model.Price</div>
            </div>
            @if (Model.SellerId != User?.GetUserId()?.ToString() && User?.Identity?.IsAuthenticated == true)
            {
                @if (await favouriteService.IsCarListingInFavourites(Model.Id, User.GetUserId()) == false)
                {
                    <div class="title-fav">
                        <span class="favorite-star text-primary">
                        <form method="post" asp-action="AddToFavourites" asp-controller="User">
                                @Html.AntiForgeryToken()
                            <input type="hidden" name="carListingId" value="@Model.Id" />
                            <button type="submit" class="fav-button">
                            <i class="bi bi-star star" id="star"></i>
                            </button>
                        </form>
                    </span>
                    </div>
                }
                else
                {
                    <div class="title-fav">
                        <span class="favorite-star text-primary">
                            <form method="post" asp-action="RemoveFromFavourites" asp-controller="User">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="carListingId" value="@Model.Id" />
                                <button type="submit" class="fav-button">
                                    <i class="bi bi-star-fill clicked star" id="star"></i>
                                </button>
                            </form>
                        </span>
                    </div>
                }
            }
        </div>
        <div class="car-details mt-1 text-muted">
            <span>@Model.Year year</span>
            <span>@Model.Milleage km</span>
            <span>@Model.FuelType</span>
            <span>@Model.Whp hp</span>
            <span>@Model.EngineDisplacement cc</span>
            <span>@Model.GearType</span>
            <span>@Model.BodyType</span>
        </div>
        <div class="car-description">
            @Model.Description
        </div>
        <div class="car-bottom-container">
        <div class="car-region d-flex flex-column">
                @if (@Model.LocationRegion == "Out of Bulgaria")
                {
                    <span>Location: @Model.LocationTown</span>
                }
                else {
                    <span>Location: @Model.LocationRegion, @Model.LocationTown</span>
                }
                <div class="car-dateposted">
                    @Model.DatePosted
                </div>
        </div>
        @if (User?.Identity?.IsAuthenticated == true)
            {
                <div class="options">
                    <div class="btn-group">
                        <button type="button" class="button-options" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical options-dots"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            @if (Model.SellerId == User?.GetUserId())
                            {
                                <li><a class="dropdown-item" asp-controller="User" asp-action="EditListing" asp-route-Id="@Model.Id">Edit</a></li>
                            }
                            @if (Model.SellerId == User?.GetUserId() || User?.IsInRole(AdminRoleName) == true)
                            {
                                <li><a class="dropdown-item" asp-controller="User" asp-action="Delete" asp-route-Id="@Model.Id">Delete</a></li>
                            }
                            @if (Model.SellerId != User?.GetUserId())
                            {
                                <li><a class="dropdown-item" asp-controller="User" asp-action="Report" asp-route-carListingId="@Model.Id">Report</a></li>
                            }
                        </ul>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<script>
    var stars = document.querySelectorAll('.star');

    stars.forEach(function (star) {
        star.addEventListener("mouseenter", function () {
            if (!this.classList.contains('clicked')) {
                this.classList.remove("bi-star");
                this.classList.add("bi-star-fill");
            }
        });

        star.addEventListener("mouseleave", function () {
            if (!this.classList.contains('clicked')) {
                this.classList.remove("bi-star-fill");
                this.classList.add("bi-star");
            }
        });

        star.addEventListener("click", function () {
            if (!this.classList.contains('clicked')) {
                this.classList.remove("bi-star");
                this.classList.add("bi-star-fill");
                this.classList.add("clicked");
            }
        });
    });
</script>
